<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grilla ¬∑ Administraci√≥n (UDELAR)</title>
<style>
  :root{
    --bg:#0b0d12; --card:#121521; --muted:#94a3b8; --txt:#e2e8f0; --brand:#7c3aed; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --chip:#1f2433;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0c11, #0f1421 45%, #0a0c11 100%);color:var(--txt);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.4;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:20px;margin:0;font-weight:700}
  .brand small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  .pill{background:rgba(124,58,237,.15);color:#d6bcff;border:1px solid rgba(124,58,237,.35);padding:6px 10px;border-radius:999px;font-size:12px}
  .card{background:var(--card);border:1px solid #23283a;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){.grid{grid-template-columns: 1fr 320px}}
  .progress{padding:16px}
  .bar{height:10px;background:#1f2636;border-radius:999px;overflow:hidden;position:relative}
  .bar>span{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--brand),#22c55e);border-radius:999px;transition:width .5s ease}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .kpi{background:#111628;padding:10px;border-radius:12px;border:1px solid #222a40}
  .kpi b{font-size:18px;display:block}
  .filters{padding:16px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .filters select,.filters input[type="search"]{background:#12192a;color:var(--txt);border:1px solid #232b44;padding:10px;border-radius:10px}
  .tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
  .tag{background:var(--chip);border:1px solid #2b3247;color:#c7d2fe;padding:6px 8px;border-radius:999px;font-size:12px}
  .list{padding:16px}
  .course{display:flex;gap:12px;align-items:flex-start;background:#0f1424;border:1px solid #202746;border-radius:14px;padding:12px;margin:10px 0}
  .course.locked{opacity:.7}
  .course h3{margin:0 0 4px 0;font-size:16px}
  .course small{color:var(--muted)}
  .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2a2f47;background:#151b2d}
  .badge.ok{color:#c7ffd1;border-color:rgba(22,163,74,.45);background:rgba(22,163,74,.12)}
  .badge.cur{color:#ffe7b3;border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12)}
  .badge.pen{color:#ffc0c0;border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}
  .area{font-size:11px;padding:4px 8px;border-radius:8px;border:1px solid #2a2f47;background:#0f1526;color:#c7d2fe}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .act{margin-left:auto;display:flex;gap:8px;align-items:center}
  button, .btn{background:#141b2f;color:#e5e7eb;border:1px solid #253051;padding:9px 12px;border-radius:10px;cursor:pointer}
  button:hover,.btn:hover{filter:brightness(1.05)}
  input[type="checkbox"]{width:18px;height:18px}
  .muted{color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}
  .empty{padding:22px;text-align:center;color:#94a3b8}
  /* Modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{max-width:720px;width:100%}
  .modal .card{padding:18px}
  .modal h2{margin:0 0 8px}
  .modal p{margin:0 0 6px}
  .modal .foot{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .link{color:#c7d2fe;text-decoration:underline}
  .right{float:right}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div>
        <h1>Grilla ¬∑ Administraci√≥n</h1>
        <small>Facultad de Ciencias Econ√≥micas y de Administraci√≥n ¬∑ UDELAR</small>
      </div>
    </div>
    <span class="pill">Hecho con üíú por Notegood.uy</span>
  </header>

  <div class="grid">
    <!-- Columna principal -->
    <section class="card">
      <div class="progress">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div>
            <b>Tu avance:</b>
            <span class="muted" id="progress-label">0% ¬∑ 0/0 cr√©ditos</span>
          </div>
          <div class="right">
            <button id="btn-onboarding">Gu√≠a r√°pida</button>
            <button id="btn-reset">Borrar progreso</button>
          </div>
        </div>
        <div class="bar"><span id="bar"></span></div>
        <div class="kpis">
          <div class="kpi"><small>Materias aprobadas</small><b id="kpi-aprobadas">0</b></div>
          <div class="kpi"><small>Materias totales</small><b id="kpi-totales">0</b></div>
          <div class="kpi"><small>Cr√©ditos aprobados</small><b id="kpi-creditos">0</b></div>
        </div>
      </div>
      <div class="filters">
        <input id="q" type="search" placeholder="Buscar por c√≥digo o nombre‚Ä¶" />
        <select id="f-estado">
          <option value="">Estado: Todos</option>
          <option value="aprobada">Aprobada</option>
          <option value="cursando">Cursando</option>
          <option value="pendiente">Pendiente</option>
        </select>
        <select id="f-anio"><option value="">A√±o: Todos</option></select>
        <select id="f-sem"><option value="">Semestre: Todos</option></select>
        <select id="f-area"><option value="">√Årea: Todas</option></select>
        <select id="f-tipo">
          <option value="">Tipo: Todas</option>
          <option value="OB">Obligatoria</option>
          <option value="OP">Opcional</option>
        </select>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- Lateral -->
    <aside class="card" style="padding:16px">
      <h3 style="margin-top:0">Leyenda y notas</h3>
      <div class="tags">
        <span class="badge ok">Aprobada</span>
        <span class="badge cur">Cursando</span>
        <span class="badge pen">Pendiente</span>
      </div>
      <p class="muted" style="margin-top:10px">Marca como <b>Aprobada</b> para sumar cr√©ditos. Si una materia tiene <b>previas</b>, ver√°s el detalle y se bloquear√° hasta que las cumplas.</p>
      <hr style="border-color:#202746;border-top:none;margin:16px 0" />
      <h4>√Åreas</h4>
      <div id="areas-list" class="tags"></div>
      <hr style="border-color:#202746;border-top:none;margin:16px 0" />
      <h4>Accesos r√°pidos</h4>
      <div class="tags">
        <a class="tag" href="#" id="quick-ob">Solo obligatorias</a>
        <a class="tag" href="#" id="quick-op">Solo opcionales</a>
        <a class="tag" href="#" id="quick-clear">Limpiar filtros</a>
      </div>
    </aside>
  </div>
</div>

<!-- Modal onboarding -->
<div class="modal-back center" id="onboarding">
  <div class="modal">
    <div class="card">
      <h2>Bienvenida üëã</h2>
      <p>Esta es tu grilla interactiva de <b>Administraci√≥n</b>. Marca tus materias como <b>Aprobada</b> o <b>Cursando</b> y observa c√≥mo se actualiza tu avance y cr√©ditos.</p>
      <ul>
        <li>El progreso se guarda en tu navegador (puedes borrarlo con <i>Borrar progreso</i>).</li>
        <li>Si una materia tiene <b>previas</b>, no podr√°s marcarla hasta cumplirlas.</li>
        <li>Filtra por <i>a√±o, semestre, √°rea, tipo</i> o busca por nombre/c√≥digo.</li>
      </ul>
      <div class="foot">
        <button id="ob-close">Entendido</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================================
   CONFIGURACI√ìN DE DATOS
   ================================ */

/**
 * Si ya tienes un JSON en tu repo, pon:
 *   USE_EXTERNAL_JSON = true
 *   EXTERNAL_JSON_URL = 'data/materias_admin.json'  (ajusta la ruta)
 *
 * El JSON debe tener dos arreglos:
 * { "areas":[{"id":"ECO","nombre":"Econom√≠a"}, ...],
 *   "materias":[
 *     {"codigo":"ADM101","nombre":"Introducci√≥n a la Administraci√≥n","anio":1,"semestre":1,"tipo":"OB","creditos":8,"area":"ADM","previas":[]},
 *     ...
 *   ]
 * }
 */
const USE_EXTERNAL_JSON = false;
const EXTERNAL_JSON_URL = 'data/materias_admin.json';

/** Ejemplo m√≠nimo de datos (REEMPL√ÅZALO por tu malla real) */
const DATA = {
  areas: [
    { id:"ADM", nombre:"Administraci√≥n" },
    { id:"ECO", nombre:"Econom√≠a" },
    { id:"MAT", nombre:"M√©todos Cuantitativos" },
    { id:"CON", nombre:"Contabilidad" },
    { id:"DER", nombre:"Derecho" },
    { id:"SOC", nombre:"Sociales" }
  ],
  materias: [
    // A√±o 1
    { codigo:"ADM101", nombre:"Introducci√≥n a la Administraci√≥n", anio:1, semestre:1, tipo:"OB", creditos:8, area:"ADM", previas:[] },
    { codigo:"ECO101", nombre:"Microeconom√≠a I", anio:1, semestre:1, tipo:"OB", creditos:8, area:"ECO", previas:[] },
    { codigo:"MAT101", nombre:"Matem√°tica I", anio:1, semestre:1, tipo:"OB", creditos:8, area:"MAT", previas:[] },
    { codigo:"CON101", nombre:"Contabilidad Financiera I", anio:1, semestre:2, tipo:"OB", creditos:8, area:"CON", previas:["MAT101"] },
    { codigo:"ECO102", nombre:"Macroeconom√≠a I", anio:1, semestre:2, tipo:"OB", creditos:8, area:"ECO", previas:["ECO101"] },
    // A√±o 2 (ejemplo con previa m√∫ltiple)
    { codigo:"ADM201", nombre:"Teor√≠a de la Organizaci√≥n", anio:2, semestre:1, tipo:"OB", creditos:8, area:"ADM", previas:["ADM101","MAT101"] },
    // Opcional (ejemplo)
    { codigo:"DER210", nombre:"Derecho Empresarial", anio:2, semestre:2, tipo:"OP", creditos:6, area:"DER", previas:[] },
  ]
};

/* ================================
   L√ìGICA
   ================================ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const stateKey = "grilla-admin-v1";
let state = {
  aprobadas: new Set(),
  cursando: new Set(),
  data: { areas:[], materias:[] }
};

function saveState(){
  const obj = {
    aprobadas: Array.from(state.aprobadas),
    cursando: Array.from(state.cursando)
  };
  localStorage.setItem(stateKey, JSON.stringify(obj));
}
function loadState(){
  const raw = localStorage.getItem(stateKey);
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    state.aprobadas = new Set(obj.aprobadas||[]);
    state.cursando = new Set(obj.cursando||[]);
  }catch{}
}

function areaName(id){ return (state.data.areas.find(a=>a.id===id)||{}).nombre || id; }

function buildFilters(){
  const a√±os = [...new Set(state.data.materias.map(m=>m.anio))].sort((a,b)=>a-b);
  const sems = [...new Set(state.data.materias.map(m=>m.semestre))].sort((a,b)=>a-b);
  const $anio = $('#f-anio'), $sem = $('#f-sem'), $area = $('#f-area');
  a√±os.forEach(v=>{$anio.insertAdjacentHTML('beforeend', `<option value="${v}">${v}¬∞</option>`);});
  sems.forEach(v=>{$sem.insertAdjacentHTML('beforeend', `<option value="${v}">${v}¬∞</option>`);});
  state.data.areas.forEach(a=>{$area.insertAdjacentHTML('beforeend', `<option value="${a.id}">${a.nombre}</option>`);});

  // Lateral √°reas
  const $areasList = $('#areas-list');
  $areasList.innerHTML = '';
  state.data.areas.forEach(a=>{
    const span = document.createElement('span');
    span.className = 'tag';
    span.textContent = `${a.id} ¬∑ ${a.nombre}`;
    $areasList.appendChild(span);
  });

  // Quick links
  $('#quick-ob').addEventListener('click', (e)=>{e.preventDefault(); $('#f-tipo').value='OB'; render();});
  $('#quick-op').addEventListener('click', (e)=>{e.preventDefault(); $('#f-tipo').value='OP'; render();});
  $('#quick-clear').addEventListener('click', (e)=>{e.preventDefault(); $$('#f-anio,#f-sem,#f-area,#f-tipo,#f-estado').forEach(el=>el.value=''); $('#q').value=''; render();});
}

function matchesFilters(m){
  const q = $('#q').value.trim().toLowerCase();
  const fa = $('#f-anio').value;
  const fs = $('#f-sem').value;
  const far = $('#f-area').value;
  const ft = $('#f-tipo').value;
  const fe = $('#f-estado').value;

  if(q && !(m.nombre.toLowerCase().includes(q) || m.codigo.toLowerCase().includes(q))) return false;
  if(fa && String(m.anio)!==fa) return false;
  if(fs && String(m.semestre)!==fs) return false;
  if(far && m.area!==far) return false;
  if(ft && m.tipo!==ft) return false;

  if(fe){
    const est = getEstado(m.codigo);
    if(est!==fe) return false;
  }
  return true;
}

function getEstado(cod){
  if(state.aprobadas.has(cod)) return 'aprobada';
  if(state.cursando.has(cod)) return 'cursando';
  return 'pendiente';
}

function canTake(m){
  // Todas las previas deben estar en aprobadas
  return (m.previas||[]).every(c=>state.aprobadas.has(c));
}

function render(){
  const list = $('#list');
  const items = state.data.materias.filter(matchesFilters)
     .sort((a,b)=> (a.anio-b.anio) || (a.semestre-b.semestre) || a.codigo.localeCompare(b.codigo));

  list.innerHTML = '';
  if(!items.length){
    list.innerHTML = `<div class="empty">No hay materias que coincidan con los filtros.</div>`;
  }else{
    items.forEach(m=>{
      const est = getEstado(m.codigo);
      const locked = !canTake(m) && est!=='aprobada' && est!=='cursando';
      const prevText = (m.previas&&m.previas.length)
        ? `Previas: ${m.previas.map(c=>`<code>${c}</code>`).join(', ')}`
        : 'Sin previas';

      const badgeClass = est==='aprobada'?'ok':(est==='cursando'?'cur':'pen');
      const disabled = locked ? 'disabled' : '';
      const lockMsg = locked ? `<div class="muted" style="font-size:12px">Debes aprobar ${m.previas.map(c=>`<b>${c}</b>`).join(', ')} para cursar.</div>` : '';

      list.insertAdjacentHTML('beforeend', `
        <div class="course ${locked?'locked':''}">
          <div class="meta">
            <span class="badge ${badgeClass}">${est.charAt(0).toUpperCase()+est.slice(1)}</span>
            <span class="area">${m.area} ¬∑ ${areaName(m.area)}</span>
            <span class="badge">${m.anio}¬∞ a√±o ¬∑ ${m.semestre}¬∞ sem</span>
            <span class="badge">Cr√©ditos: ${m.creditos}</span>
            <span class="badge">${m.tipo==='OB'?'Obligatoria':'Opcional'}</span>
          </div>
          <div style="flex:1">
            <h3>${m.codigo} ‚Äî ${m.nombre}</h3>
            <small class="muted">${prevText}</small>
            ${lockMsg}
          </div>
          <div class="act">
            <label class="muted">Cursando <input type="checkbox" data-cur="${m.codigo}" ${state.cursando.has(m.codigo)?'checked':''} ${disabled}></label>
            <label class="muted">Aprobada <input type="checkbox" data-ok="${m.codigo}" ${state.aprobadas.has(m.codigo)?'checked':''}></label>
          </div>
        </div>
      `);
    });
  }

  // Eventos de check
  $$('input[data-cur]').forEach(el=>{
    el.onchange = ()=>{
      const cod = el.getAttribute('data-cur');
      if(el.checked){
        state.cursando.add(cod);
      }else{
        state.cursando.delete(cod);
      }
      saveState(); updateProgress(); render(); // re-render por si cambia bloqueo
    };
  });
  $$('input[data-ok]').forEach(el=>{
    el.onchange = ()=>{
      const cod = el.getAttribute('data-ok');
      if(el.checked){
        state.aprobadas.add(cod);
        // si aprobada, quitar cursando
        state.cursando.delete(cod);
      }else{
        state.aprobadas.delete(cod);
      }
      saveState(); updateProgress(); render();
    };
  });

  updateKpis();
}

function updateKpis(){
  const total = state.data.materias.length;
  const aprobadas = state.data.materias.filter(m=>state.aprobadas.has(m.codigo)).length;
  const credTot = state.data.materias.reduce((s,m)=>s+Number(m.creditos||0),0);
  const credOk = state.data.materias.filter(m=>state.aprobadas.has(m.codigo))
                  .reduce((s,m)=>s+Number(m.creditos||0),0);

  $('#kpi-aprobadas').textContent = aprobadas;
  $('#kpi-totales').textContent = total;
  $('#kpi-creditos').textContent = credOk;

  const pct = credTot? Math.round(credOk/credTot*100):0;
  $('#progress-label').textContent = `${pct}% ¬∑ ${credOk}/${credTot} cr√©ditos`;
  $('#bar').style.width = pct+'%';
}

function updateProgress(){ updateKpis(); }

function wireUI(){
  $$('#q,#f-anio,#f-sem,#f-area,#f-tipo,#f-estado').forEach(el=>{
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });
  $('#btn-reset').onclick = ()=>{
    if(confirm('Esto borrar√° tu progreso guardado en este navegador. ¬øDeseas continuar?')){
      localStorage.removeItem(stateKey);
      state.aprobadas.clear(); state.cursando.clear();
      render(); updateProgress();
    }
  };

  // onboarding
  const seenKey = 'grilla-admin-onb';
  const $ob = $('#onboarding');
  function openOnb(){ $ob.style.display='flex'; }
  function closeOnb(){ $ob.style.display='none'; localStorage.setItem(seenKey,'1'); }
  $('#btn-onboarding').onclick = openOnb;
  $('#ob-close').onclick = closeOnb;
  $ob.addEventListener('click', (e)=>{ if(e.target=== $ob) closeOnb(); });
  if(!localStorage.getItem(seenKey)) openOnb();
}

async function init(){
  loadState();
  let json = null;
  if(USE_EXTERNAL_JSON){
    const r = await fetch(EXTERNAL_JSON_URL);
    json = await r.json();
  }else{
    json = DATA;
  }
  // Sanitizar campos: asegurar arrays en previas
  json.materias = json.materias.map(m=>({
    ...m,
    previas: Array.isArray(m.previas) ? m.previas : (typeof m.previas==='string' && m.previas.trim()? m.previas.split(/[,\s;]+/).filter(Boolean):[])
  }));
  state.data = json;

  buildFilters();
  wireUI();
  render();
  updateProgress();
}

init();
</script>
</body>
</html>
